<!DOCTYPE html>
<html>

<head>
	<title>Role Detail - <%= role[pathway.id][levelId].title %></title>
	<%- include('_styles') %>
</head>

<body>
	<div class="page">
		<%- include('_nav') %>

		<section class="hero">
			<h1><%= role[pathway.id][levelId].title %></h1>
			<p>
				<span class="badge badge--accent"><%= role.name %></span>
				<span class="badge"><%= pathway.description %></span>
				<span class="badge badge--ok">Level <%= levelId %></span>
			</p>
		</section>

	<% let level = role[pathway.id][levelId] %>

		<div style="display: flex; flex-direction: column; gap: 12px;">
			<% skills.categories.forEach(category=> { %>
				<section class="card">
					<div class="card__body">
						<div class="item-title">
							<div class="item-title__name"><%= category.name %></div>
							<div class="badge"><%= category.id %></div>
						</div>

						<% const selected = role[pathway.id] && role[pathway.id].selected_skills %>
						<% const selectedSet = Array.isArray(selected) ? new Set(selected) : null %>
						<% const categorySkills = (skills.skills || []).filter(skill => skill.category_id === category.id) %>
						<% const visibleSkills = selectedSet ? categorySkills.filter(skill => selectedSet.has(skill.id)) : categorySkills %>
						<% const competencies = visibleSkills.map(skill => ({ skill, competency: level[skill.id] })).filter(x => x.competency != null).sort((a,b) => (a.skill.name || '').localeCompare(b.skill.name || '')) %>
						<div style="margin-top: 8px;">
							<span class="badge"><%= competencies.length %> skills</span>
							<% if (selectedSet) { %>
								<span class="badge">selected</span>
							<% } %>
						</div>

						<% if (competencies.length === 0) { %>
							<div style="color: var(--muted); font-size: 13px;">
								<% if (selectedSet) { %>
									No selected skills in this category for this role/pathway.
								<% } else { %>
									No competencies set for this category at this level.
								<% } %>
							</div>
						<% } %>

						<% if (competencies.length > 0) { %>
							<div class="table-wrap" style="margin-top: 10px;">
								<table style="min-width: 720px;">
									<thead>
										<tr>
											<th>Skill</th>
											<th>Required Level</th>
											<th>Description</th>
										</tr>
									</thead>
									<tbody>
										<% competencies.forEach(({ skill, competency }) => { %>
											<% let skillLevel = (skill.levels || []).find(l => l.level == competency) %>
											<% let lev = (skills.levels || []).find(l => l.level == competency) %>
											<tr>
												<td>
													<div class="item-title">
														<a class="item-title__name" href="/skills/<%= skill.id %>/"><%= skill.name %></a>
														<span class="badge"><%= skill.id %></span>
													</div>
												</td>
												<td>
													<a href="/skills/<%= skill.id %>/level/<%= competency %>">
														<span class="badge badge--ok">Level <%= competency %><% if (lev) { %> • <%= lev.level_name %><% } %></span>
													</a>
												</td>
												<td style="color: var(--muted); font-size: 13px;">
													<% if (skillLevel) { %>
														<% const brief = (skillLevel.brief_description || '').trim() %>
														<% const full = (skillLevel.full_description || '').trim() %>
														<% if (brief) { %>
															<%= brief %>
														<% } else if (full) { %>
															<%= full.length > 220 ? (full.slice(0, 220) + '…') : full %>
														<% } else { %>
															<span style="color: var(--faint);">No skill-level description available.</span>
														<% } %>
													<% } else { %>
														<span style="color: var(--faint);">No skill-level description available.</span>
													<% } %>
												</td>
											</tr>
										<% }) %>
									</tbody>
								</table>
							</div>
						<% } %>
					</div>
				</section>
			<% }); %>
		</div>

		<%- include('_footer') %>
	</div>
</body>

</html>
